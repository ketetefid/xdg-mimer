name: Build and Package for Release

on:
  release:
    types: [created]

jobs:
  build-linux:
    name: Build DEB & RPM Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from Cargo.toml
        id: extract_version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -n 1 | cut -d '"' -f2)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Install packaging tools and deps
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts debhelper rpm build-essential pkg-config

      - name: Install GTK dependencies
        run: |
          sudo apt-get install -y \
            libgtk-4-dev \
            libglib2.0-dev \
            libgdk-pixbuf-2.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libgraphene-1.0-dev \
            libgirepository1.0-dev \
            libatk1.0-dev
          
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build binary
        run: cargo build --release
    
      - name: Package as .tar.gz
        run: |
          mkdir -p dist
          mv target/release/xdg_mimer target/release/xdg-mimer
          cp target/release/xdg-mimer dist/
          tar -czvf dist/xdg-mimer-${{ env.VERSION }}-linux.tar.gz -C dist xdg-mimer

      # ----- DEB BUILD -----
      - name: Prepare Debian changelog
        run: |
          cp -r debian debuild/
          cp -r * debuild/
          cd debuild
          echo "xdg-mimer ($VERSION) unstable; urgency=medium" > debian/changelog
          echo "" >> debian/changelog
          echo "  * Auto-generated release." >> debian/changelog
          echo "" >> debian/changelog
          echo " -- GitHub Actions <no-reply@github.com>  $(date -R)" >> debian/changelog

      - name: Build .deb
        run: |
          cd debuild
          dpkg-buildpackage -us -uc
          cd ..
          mv *.deb dist/

      # ----- RPM BUILD -----
      - name: Prepare RPM sources
        run: |
          sed "s/^Version:.*/Version:        $VERSION/" xdg-mimer.spec > updated.spec
          mkdir -p rpmbuild/SOURCES
          tar czf rpmbuild/SOURCES/xdg-mimer-$VERSION.tar.gz --transform "s,^,xdg-mimer-$VERSION/," .
          mv updated.spec xdg-mimer.spec

      - name: Build .rpm
        run: |
          rpmbuild -ba xdg-mimer.spec --define "_topdir $(pwd)/rpmbuild"
          cp rpmbuild/RPMS/x86_64/*.rpm dist/

      # ----- Upload -----
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          
  build-arch:
    name: Build Arch Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      
    steps:
      - uses: actions/checkout@v4
      - name: Extract version from Cargo.toml
        id: extract_version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -n 1 | cut -d '"' -f2)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        
      - name: Replace version in PKGBUILD
        run: sed -i "s/@VERSION@/${{ env.VERSION }}/g" PKGBUILD

      - name: Install system and build dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            cargo \
            rust \
            gtk4 \
            glib2 \
            gdk-pixbuf2 \
            cairo \
            pango \
            graphene \
            gobject-introspection \
            atk

      - name: Add builder user and change ownership
        run: |
          useradd -m builder
          chown -R builder .

      - name: Create source tarball for Arch
        run: |
          mkdir -p buildsrc
          shopt -s dotglob
          cp -r $(ls -A | grep -vE '^xdg-mimer-[0-9]+\.[0-9]+\.[0-9]+(\.tar\.gz)?$') buildsrc/
          mv buildsrc xdg-mimer-${VERSION}
          tar -czf xdg-mimer-${VERSION}.tar.gz xdg-mimer-${VERSION}
    
      - name: Build package (no sudo required)
        run: |
          su builder -c "makepkg -s --noconfirm"

      - name: Upload .pkg.tar.zst
        uses: softprops/action-gh-release@v1
        with:
          files: ./*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
